<?xml version="1.0"?>

<project name="Test sampler deployment" basedir="." default="all">
    
	<!-- Test with these browsers -->
	<property name="test_browsers" value="winxp-firefox35" />

	<!-- Target deploying demo.war -->
	<property name="sshHost" value="rndtestlinux.office.itmill.com" />
	
	<!-- Key file to use -->
	<property name="key.file" value="id_rsa" />
	
	<!-- path and name for demo.war to be deployed -->
	<property name="demo.war" value="demo.war"/>
	
	<!-- Host running Testbench RC or Testbench Hub -->
	<property name="com.vaadin.testbench.tester.host" value="127.0.0.1" />

	<!-- Base url where the testable application is deployed -->
	<property name="deployment.url" value="http://${sshHost}:8080" />

	<!-- ssh host values -->
	<property name="ant.hub" value="/home/rnd/deploy.xml" />
	<property name="user" value="rnd" />
	<property name="passphrase" value="" />
	
	<!-- Upload war to deploy to ssh host -->
	<target name="upload-demo">
		<scp file="${demo.war}" todir="${user}@${sshHost}:servers/demo.war" keyfile="${key.file}" passphrase="${passphrase}" />
	</target>
	
	<!-- Run sampler deployment test -->
	<target name="test-sampler">
		<fileset dir="integration-testscripts" id="html-test-files" includes="sampler_deployment.html"/>
		<pathconvert pathsep=" " property="testfiles" refid="html-test-files" />
		
		<subant target="run-tests" failonerror="false" antfile="test.xml">
			<property name="com.vaadin.testbench.lib.dir" value="${com.vaadin.testbench.lib.dir}"/>
			<property name="com.vaadin.testbench.tester.host" value="${com.vaadin.testbench.tester.host}" />
			<property name="com.vaadin.testbench.deployment.url" value="${deployment.url}" />
			<property name="browsers" value="${test_browsers}" />
			<property name="testfiles" value="${testfiles}" />
			
			<fileset dir="." includes="test.xml" />
		</subant>
	</target>
	
	<!-- Start and stop methods for servers -->
	<target name="start-tomcat-4">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-tomcat-4.1.40" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="tomcat-4.1.40" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-tomcat-4">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-tomcat-4.1.40" />
	</target>
	
	<target name="start-tomcat-5">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-tomcat-5.5.28" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="tomcat-5.5.28" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-tomcat-5">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-tomcat-5.5.28" />
	</target>
	
	<target name="start-tomcat-6">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-tomcat-6.0.20" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="tomcat-6.0.20" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-tomcat-6">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-tomcat-6.0.20" />
	</target>
	
	<target name="start-jetty-5">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-jetty-5.1.15" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="jetty-5.1.15" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-jetty-5">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-jetty-5.1.15" />
	</target>

	<target name="start-jetty-6">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-jetty-6.1.22" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="jetty-6.1.22" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-jetty-6">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-jetty-6.1.22" />
	</target>
	
	<target name="start-jetty-7">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-jetty-7.0.0" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="jetty-7.0.0" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-jetty-7">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-jetty-7.0.0" />
	</target>
	
	<target name="start-jboss-3">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-jboss-3.2.8" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="jboss-3.2.8" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-jboss-3">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-jboss-3.2.8" />
	</target>
	
	<target name="start-jboss-4">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-jboss-4.2.3" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="jboss-4.2.3" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-jboss-4">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-jboss-4.2.3" />
	</target>
	
	<target name="start-jboss-5">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-jboss-5.0.1" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="jboss-5.0.1" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-jboss-5">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-jboss-5.0.1" />
	</target>
	
	<target name="start-glassfish">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-glassfish-2.1.1" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="glassfish-2.1.1" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>
	
	<target name="stop-glassfish">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-glassfish-2.1.1" />
	</target>
	
	<!-- Test liferay sampler -->
	<target name="test-liferay">
		<fileset dir="integration-testscripts" id="html-test-files" includes="sampler_deployment_liferay.html"/>
		<pathconvert pathsep=" " property="test-liferay" refid="html-test-files" />
		
		<subant target="run-tests" failonerror="false" antfile="test.xml">
			<property name="com.vaadin.testbench.lib.dir" value="${com.vaadin.testbench.lib.dir}"/>
			<property name="com.vaadin.testbench.tester.host" value="${com.vaadin.testbench.tester.host}" />
			<property name="com.vaadin.testbench.deployment.url" value="${deployment.url}" />
			<property name="browsers" value="${test_browsers}" />
			<property name="testfiles" value="${test-liferay}" />
			
			<fileset dir="." includes="test.xml" />
		</subant>
	</target>
	
	<!-- "deploy" sampler to liferay -->
	<target name="init-liferay">
		<fileset dir="integration-testscripts" id="html-test-files" includes="Add_Sampler_to_Liferay.html"/>
		<pathconvert pathsep=" " property="init-liferay" refid="html-test-files" />
		
		<subant target="run-tests" failonerror="false" antfile="test.xml">
			<property name="com.vaadin.testbench.lib.dir" value="${com.vaadin.testbench.lib.dir}"/>
			<property name="com.vaadin.testbench.tester.host" value="${com.vaadin.testbench.tester.host}" />
			<property name="com.vaadin.testbench.deployment.url" value="${deployment.url}" />
			<property name="browsers" value="winxp-firefox35" />
			<property name="testfiles" value="${init-liferay}" />
	
			<fileset dir="." includes="test.xml" />
		</subant>
	</target>
	
	<target name="start-liferay">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-liferay-5.2.3" />
	</target>

	<target name="stop-liferay">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-liferay-5.2.3" />
	</target>
	
	<!-- Run sampler deployment test for WebLogic server -->
	<target name="test-weblogic">
		<fileset dir="integration-testscripts" id="html-test-files" includes="sampler_deployment.html"/>
		<pathconvert pathsep=" " property="test-weblogic" refid="html-test-files" />
		
		<subant target="run-tests" failonerror="false" antfile="test.xml">
			<property name="com.vaadin.testbench.lib.dir" value="${com.vaadin.testbench.lib.dir}"/>
			<property name="com.vaadin.testbench.tester.host" value="${com.vaadin.testbench.tester.host}" />
			<property name="com.vaadin.testbench.deployment.url" value="http://${sshHost}:7001" />
			<property name="browsers" value="${test_browsers}" />
			<property name="testfiles" value="${test-weblogic}" />
			
			<fileset dir="." includes="test.xml" />
		</subant>
	</target>
	
	<target name="start-weblogic9">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-weblogic-9.2" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="weblogic-9.2" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-weblogic9">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-weblogic-9.2" />
	</target>
	
	<target name="start-weblogic10">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} start-weblogic-10.3" />
		<copy file="integration-testscripts/sampler_deployment.tpl" tofile="integration-testscripts/sampler_deployment.html" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="server" value="weblogic-10.3" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="stop-weblogic10">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} stop-weblogic-10.3" />
	</target>
	
	<!-- Server setup, test and teardown targets. -->
	<target name="tomcat4">
		<antcall target="start-tomcat-4"/>
		<antcall target="test-sampler"/>
		<antcall target="stop-tomcat-4"/>
	</target>
	
	<target name="tomcat5">
		<antcall target="start-tomcat-5"/>
		<antcall target="test-sampler"/>
		<antcall target="stop-tomcat-5"/>
	</target>	
	
	<target name="tomcat6">
		<antcall target="start-tomcat-6"/>
		<antcall target="test-sampler"/>
		<antcall target="stop-tomcat-6"/>
	</target>
	
	<target name="jetty5">
		<antcall target="start-jetty-5"/>
		<antcall target="test-sampler"/>
		<antcall target="stop-jetty-5"/>
	</target>
	
	<target name="jetty6">
		<antcall target="start-jetty-6"/>
		<antcall target="test-sampler"/>
		<antcall target="stop-jetty-6"/>
	</target>
	
	<target name="jetty7">
		<antcall target="start-jetty-7"/>
		<antcall target="test-sampler"/>
		<antcall target="stop-jetty-7"/>
	</target>
	
	<target name="jboss3">
		<antcall target="start-jboss-3"/>
		<antcall target="test-sampler"/>
		<antcall target="stop-jboss-3"/>
	</target>
	
	<target name="jboss4">
		<antcall target="start-jboss-4"/>
		<antcall target="test-sampler"/>
		<antcall target="stop-jboss-4"/>
	</target>
	
	<target name="jboss5">
		<antcall target="start-jboss-5"/>
		<antcall target="test-sampler"/>
		<antcall target="stop-jboss-5"/>
	</target>
		
	<target name="glassfish">
		<antcall target="start-glassfish"/>
		<antcall target="test-sampler"/>
		<antcall target="stop-glassfish"/>
	</target>
	
	<target name="liferay" depends="start-liferay,init-liferay,test-liferay,stop-liferay" />
	
	<target name="weblogic9">
		<antcall target="start-weblogic9"/>
		<antcall target="test-weblogic"/>
		<antcall target="stop-weblogic9"/>
	</target>
	
	<target name="weblogic10">
		<antcall target="start-weblogic10"/>
		<antcall target="test-weblogic"/>
		<antcall target="stop-weblogic10"/>
	</target>
	
	<!-- Upload demo, clean error screenshots and test deployment on all servers -->
	<target name="all" depends="upload-demo,tomcat4,tomcat5,tomcat6,jetty5,jetty6,jetty7,jboss3,jboss4,jboss5,glassfish,liferay,weblogic9,weblogic10,clean" />
	
	<!-- Remove demo.war -->
	<target name="clean">
		<sshexec host="${sshHost}" username="${user}" keyfile="${key.file}" command="ant -f ${ant.hub} clean" />
	</target>
	
	<!-- Remove old screenshots if any -->
	<target name="clean-old">
		<subant target="remove-error-screens">
			<fileset dir="." includes="test.xml" />
		</subant>
	</target>
</project>